(function(b,u,C,p,h,D,L,N,U){"use strict";function k(){return U.useProxy(h.storage),React.createElement(N.ErrorBoundary,null,React.createElement(C.ReactNative.ScrollView,null,React.createElement(N.Forms.FormSwitchRow,{label:"Split messages on words instead of newlines",subLabel:"Results in the lowest amount of messages",onValueChange:function(s){return h.storage.splitOnWords=s},value:h.storage.splitOnWords})))}let m;const S=new Map,y=[],P=new WeakSet,_=new WeakSet;let w;h.storage.splitOnWords??=!1;function x(){S.clear();const s=u.findAll(function(e){return e&&typeof e=="object"&&Object.keys(e).some(function(o){return o.includes("MAX_MESSAGE_LENGTH")})});for(const e of s){const o={};let n=!1;for(const a of Object.keys(e))a.includes("MAX_MESSAGE_LENGTH")&&typeof e[a]=="number"&&(o[a]=e[a],e[a]=2**30,n=!0);n&&S.set(e,o)}}function z(){for(const[s,e]of S)for(const[o,n]of Object.entries(e))s[o]=n;S.clear()}function F(s){return new Promise(function(e){return setTimeout(e,s)})}function M(s,e=[],o=0){if(s==null||o>6)return e;if(typeof s=="string")return e.push(s),e;if(Array.isArray(s)){for(const n of s)M(n,e,o+1);return e}if(typeof s=="object")for(const[n,a]of Object.entries(s))n==="onConfirm"||n==="onCancel"||n==="render"||n==="children"||M(a,e,o+1);return e}function B(s,e){if(!e?.getDraft)return"";try{const o=e.getDraft(s,0);if(typeof o=="string")return o}catch{}try{const o=e.getDraft(s);if(typeof o=="string")return o}catch{}return""}function j(s,e){const o=[];return h.storage.splitOnWords||o.push(s.split(`
`).reduce(function(n,a){return n.length+a.length+2>e?(o.push(n),a+`
`):n?n+a+`
`:a+`
`},"")),o.length&&!o.some(function(n){return n.length>e})?o.map(function(n){return n.trim()}):(o.length=0,o.push(s.split(" ").reduce(function(n,a){return n.length+a.length+2>e?(o.push(n),a+" "):n?n+a+" ":a+" "},"")),o.some(function(n){return n.length>e})?!1:o.map(function(n){return n.trim()}))}var H={onLoad(){const s=u.findByStoreName("ChannelStore"),e=u.findByStoreName("SelectedChannelStore"),o=u.findByStoreName("UserStore"),n=u.findByProps("sendMessage","editMessage"),a=u.findByProps("getDraft"),v=u.findByProps("clearDraft","saveDraft"),A=u.findByProps("clearAll"),O=u.findByProps("show","openLazy"),X=n.sendMessage.bind(n),R=async function(r,t,c){const i={invalidEmojis:t.invalidEmojis,validNonShortcutEmojis:t.validNonShortcutEmojis,tts:!1,content:c};if(typeof n._sendMessage=="function"){await n._sendMessage(r,i,{});return}await X(r,i)},d=function(){return o.getCurrentUser()?.premiumType===2?4e3:2e3},I=async function(r,t){for(const c of t)await R(r,{},c)},V=function(r,t){const c=r?.channel?.id??r?.channelId??e?.getChannelId?.();if(!c)return t(r);const i=(typeof r?.content=="string"?r.content:"")||(typeof r?.text=="string"?r.text:"")||B(c,a);if(!i||i.length<=d())return t(r);const f=j(i,d());if(!f?.length)return t(r);I(c,f.filter(function(l){return l.length>0}));try{v?.clearDraft?.(c,0)}catch{}try{v?.clearDraft?.(c)}catch{}try{A?.clearAll?.(c,0)}catch{}try{A?.clearAll?.(c)}catch{}return{shouldClear:!1,shouldRefocus:!0}},T=function(r,t){const c=M(r).join(" ").replace(/\s+/g," ").toLowerCase(),i=String(C.i18n?.Messages?.YOUR_MESSAGE_IS_TOO_LONG??"").toLowerCase();if(!(c.includes("your message is too long")||c.includes("up to 4000 characters")||c.includes("2000 character count limit")||i&&c.includes(i)))return t(...r);const f=e?.getChannelId?.();if(!f)return t(...r);const l=B(f,a);if(!l||l.length<=d())return t(...r);const E=j(l,d());if(!E?.length)return t(...r);I(f,E.filter(function(g){return g.length>0}));try{v?.clearDraft?.(f,0)}catch{}try{v?.clearDraft?.(f)}catch{}try{A?.clearAll?.(f,0)}catch{}try{A?.clearAll?.(f)}catch{}},W=function(){const r=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.openWarningPopout=="function"});for(const t of r)if(!P.has(t)){P.add(t);try{y.push(p.instead("openWarningPopout",t,function([c],i){return V(c,i)}))}catch{}}},G=function(){const r=[];O&&typeof O=="object"&&r.push(O),r.push(...u.findAll(function(t){return t&&typeof t=="object"&&(typeof t.show=="function"||typeof t.openLazy=="function")}));for(const t of r)if(!_.has(t)){_.add(t);try{typeof t.show=="function"&&y.push(p.instead("show",t,function(c,i){return T(c,i)}))}catch{}try{typeof t.openLazy=="function"&&y.push(p.instead("openLazy",t,function(c,i){return T(c,i)}))}catch{}}};x(),W(),G(),w=setInterval(function(){W(),G()},3e3),m?.(),m=p.before("sendMessage",n,function(r){const[t,c]=r,i=c?.content;if(!i||i.length<=d())return;const f=j(i,d());if(!f){c.content="",L.showToast("Failed to split message",D.getAssetIDByName("Small"));return}const l=f.filter(function(g){return g.length>0});if(!l.length){c.content="",L.showToast("Failed to split message",D.getAssetIDByName("Small"));return}c.content=l.shift()??"";const E=s.getChannel(t);(async function(){for(const g of l)await F(Math.max((E?.rateLimitPerUser??0)*1e3,1e3)),await R(t,c,g)})()})},onUnload:function(){for(m?.(),m=void 0,w&&(clearInterval(w),w=void 0);y.length;)try{y.pop()?.()}catch{}z()},settings:k};return b.default=H,Object.defineProperty(b,"__esModule",{value:!0}),b})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta.storage);
