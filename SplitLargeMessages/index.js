(function(j,u,P,g,h,I,N,T,H){"use strict";function V(){return H.useProxy(h.storage),React.createElement(T.ErrorBoundary,null,React.createElement(P.ReactNative.ScrollView,null,React.createElement(T.Forms.FormSwitchRow,{label:"Split messages on words instead of newlines",subLabel:"Results in the lowest amount of messages",onValueChange:function(i){return h.storage.splitOnWords=i},value:h.storage.splitOnWords})))}let S;const w=new Map,d=[],A=new Set,E=new Set,L=new Set,_=new Set;let M;h.storage.splitOnWords??=!1;function X(){w.clear();const i=u.findAll(function(e){return e&&typeof e=="object"&&Object.keys(e).some(function(s){return s.includes("MAX_MESSAGE_LENGTH")})});for(const e of i){const s={};let r=!1;for(const f of Object.keys(e))f.includes("MAX_MESSAGE_LENGTH")&&typeof e[f]=="number"&&(s[f]=e[f],e[f]=2**30,r=!0);r&&w.set(e,s)}}function Y(){for(const[i,e]of w)for(const[s,r]of Object.entries(e))i[s]=r;w.clear()}function q(i){return new Promise(function(e){return setTimeout(e,i)})}function O(i,e=[],s=0){if(i==null||s>6)return e;if(typeof i=="string")return e.push(i),e;if(typeof i=="function"){try{e.push(Function.prototype.toString.call(i))}catch{}return e}if(Array.isArray(i)){for(const r of i)O(r,e,s+1);return e}if(typeof i=="object")for(const[r,f]of Object.entries(i))r==="onConfirm"||r==="onCancel"||r==="render"||r==="children"||O(f,e,s+1);return e}function D(i,e){if(!e?.getDraft)return"";try{const s=e.getDraft(i,0);if(typeof s=="string")return s}catch{}try{const s=e.getDraft(i);if(typeof s=="string")return s}catch{}return""}function J(i){if(!i)return!1;const e=String(i.name??""),s=String(i.type??"");return e!=="message.txt"?!1:!s||s==="text/plain"}function R(i,e){const s=[];return h.storage.splitOnWords||s.push(i.split(`
`).reduce(function(r,f){return r.length+f.length+2>e?(s.push(r),f+`
`):r?r+f+`
`:f+`
`},"")),s.length&&!s.some(function(r){return r.length>e})?s.map(function(r){return r.trim()}):(s.length=0,s.push(i.split(" ").reduce(function(r,f){return r.length+f.length+2>e?(s.push(r),f+" "):r?r+f+" ":f+" "},"")),s.some(function(r){return r.length>e})?!1:s.map(function(r){return r.trim()}))}var Z={onLoad(){const i=u.findByStoreName("ChannelStore"),e=u.findByStoreName("SelectedChannelStore"),s=u.findByStoreName("UserStore"),r=u.findByProps("sendMessage","editMessage"),f=u.findByProps("getDraft"),U=u.findByProps("clearDraft","saveDraft"),x=u.findByProps("clearAll"),b=u.findByProps("promptToUpload"),B=u.findByProps("show","openLazy"),C=u.findByProps("openModal","openModalLazy"),$=r.sendMessage.bind(r),z=async function(n,t,o){const a={invalidEmojis:t.invalidEmojis,validNonShortcutEmojis:t.validNonShortcutEmojis,tts:!1,content:o};if(typeof r._sendMessage=="function"){await r._sendMessage(n,a,{});return}await $(n,a)},y=function(){return s.getCurrentUser()?.premiumType===2?4e3:2e3},K=async function(n,t){for(const o of t)await z(n,{},o)},Q=function(n){try{U?.clearDraft?.(n,0)}catch{}try{U?.clearDraft?.(n)}catch{}try{x?.clearAll?.(n,0)}catch{}try{x?.clearAll?.(n)}catch{}},v=function(n,t){const o=(typeof t=="string"?t:"")||D(n,f);if(!o||o.length<=y())return!1;const a=R(o,y());if(!a?.length)return!1;const c=a.filter(function(l){return l.length>0});return c.length?(console.log("[SplitLargeMessages] splitting long message",{channelId:n,length:o.length,maxLength:y(),chunks:c.length}),K(n,c),Q(n),!0):!1},tt=function(n,t){const o=n?.channel?.id??n?.channelId??e?.getChannelId?.();if(!o)return t(n);const a=(typeof n?.content=="string"?n.content:"")||(typeof n?.text=="string"?n.text:"")||D(o,f);return v(o,a)?{shouldClear:!1,shouldRefocus:!0}:t(n)},nt=function(n,t){const o=O(n).join(" ").replace(/\s+/g," ").toLowerCase(),a=String(P.i18n?.Messages?.YOUR_MESSAGE_IS_TOO_LONG??"").toLowerCase();if(!(o.includes("your message is too long")||o.includes("up to 4000 characters")||o.includes("2000 character count limit")||o.includes("your_message_is_too_long")||o.includes("showlargemessagedialog")||a&&o.includes(a)))return t(...n);const c=e?.getChannelId?.();if(!c)return t(...n);if(!v(c))return t(...n)},F=function(){const n=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.openWarningPopout=="function"});for(const t of n)if(!A.has(t)){A.add(t);try{d.push(g.instead("openWarningPopout",t,function([o],a){return tt(o,a)}))}catch{}}},G=function(){const n=[];B&&typeof B=="object"&&n.push(B),C&&typeof C=="object"&&n.push(C),n.push(...u.findAll(function(t){return t&&typeof t=="object"&&(typeof t.show=="function"||typeof t.openLazy=="function"||typeof t.openModal=="function"||typeof t.openModalLazy=="function")}));for(const t of n)if(!E.has(t)){E.add(t);for(const o of["show","openLazy","openModal","openModalLazy"])try{if(typeof t[o]!="function")continue;d.push(g.instead(o,t,function(a,c){return nt(a,c)}))}catch{}}},W=function(){const n=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.promptToUpload=="function"});b&&typeof b=="object"&&typeof b.promptToUpload=="function"&&n.push(b);for(const t of n)if(!L.has(t)){L.add(t);try{d.push(g.instead("promptToUpload",t,function([o,a,c],l){const m=o?.[0],p=a?.id??e?.getChannelId?.(),et=J(m),ot=c===0||c==null;if(!p||!et||!ot||!v(p))return l(o,a,c)}))}catch{}}},k=function(){const n=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.handleSendMessage=="function"&&(typeof t.onResize=="function"||typeof t.getSendMessageOptions=="function")});for(const t of n)if(!_.has(t)){_.add(t);try{d.push(g.instead("handleSendMessage",t,function(o,a){const[c]=o,l=c?.channel?.id??c?.channelId??c?.id??e?.getChannelId?.();if(!l)return a(...o);const m=(typeof c?.content=="string"?c.content:"")||(typeof c?.text=="string"?c.text:"")||(typeof c?.message?.content=="string"?c.message.content:"");if(!v(l,m))return a(...o)}))}catch{}}};X(),F(),G(),W(),k(),M=setInterval(function(){F(),G(),W(),k()},3e3),S?.(),S=g.before("sendMessage",r,function(n){const[t,o]=n,a=o?.content;if(!a||a.length<=y())return;const c=R(a,y());if(!c){o.content="",N.showToast("Failed to split message",I.getAssetIDByName("Small"));return}const l=c.filter(function(p){return p.length>0});if(!l.length){o.content="",N.showToast("Failed to split message",I.getAssetIDByName("Small"));return}o.content=l.shift()??"";const m=i.getChannel(t);(async function(){for(const p of l)await q(Math.max((m?.rateLimitPerUser??0)*1e3,1e3)),await z(t,o,p)})()})},onUnload:function(){for(S?.(),S=void 0,M&&(clearInterval(M),M=void 0);d.length;)try{d.pop()?.()}catch{}A.clear(),E.clear(),L.clear(),_.clear(),Y()},settings:V};return j.default=Z,Object.defineProperty(j,"__esModule",{value:!0}),j})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta.storage);
