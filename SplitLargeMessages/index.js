(function(O,l,k,m,v,M,b,H,rt){"use strict";function st(){return rt.useProxy(v.storage),React.createElement(H.ErrorBoundary,null,React.createElement(k.ReactNative.ScrollView,null,React.createElement(H.Forms.FormSwitchRow,{label:"Split messages on words instead of newlines",subLabel:"Results in the lowest amount of messages",onValueChange:function(r){return v.storage.splitOnWords=r},value:v.storage.splitOnWords})))}let j,D;const C=new Map,S=[],T=new Set,N=new Set,P=new Set,U=new Set,x=new Set,I=new Set;let L,_;v.storage.splitOnWords??=!1;function X(){const r=function(s){if(!s||typeof s!="object")return;const o=s,a=C.get(o)??{};let d=!1;for(const g of Object.keys(o))g.includes("MAX_MESSAGE_LENGTH")&&typeof o[g]=="number"&&(g in a||(a[g]=o[g]),o[g]=1073741824,d=!0);d&&C.set(o,a)},c=l.findAll(function(s){return s&&typeof s=="object"&&Object.keys(s).some(function(o){return o.includes("MAX_MESSAGE_LENGTH")})});for(const s of c){r(s);for(const o of Object.values(s))!o||typeof o!="object"||r(o)}}function it(){for(const[r,c]of C)for(const[s,o]of Object.entries(c))r[s]=o;C.clear()}function ct(r){return new Promise(function(c){return setTimeout(c,r)})}function R(r,c=[],s=0){if(r==null||s>6)return c;if(typeof r=="string")return c.push(r),c;if(typeof r=="function"){try{c.push(Function.prototype.toString.call(r))}catch{}return c}if(Array.isArray(r)){for(const o of r)R(o,c,s+1);return c}if(typeof r=="object")for(const[o,a]of Object.entries(r))o==="onConfirm"||o==="onCancel"||o==="render"||o==="children"||R(a,c,s+1);return c}function B(r,c=0){if(c>4||r==null)return"";if(typeof r=="string")return r;if(typeof r!="object")return"";const s=["content","text","value","rawContent","messageContent","pendingContent"];for(const a of s){const d=r[a];if(typeof d=="string"&&d.length>0)return d}const o=["message","draft","state","editor","input","composerState","formState","richValue"];for(const a of o){const d=B(r[a],c+1);if(d)return d}return""}function A(r,c){if(!c?.getDraft)return"";try{const s=c.getDraft(r,0);if(typeof s=="string")return s}catch{}try{const s=c.getDraft(r);if(typeof s=="string")return s}catch{}return""}function Y(r){if(!r)return!1;const c=String(r.name??""),s=String(r.type??"");return c!=="message.txt"?!1:!s||s==="text/plain"}function ft(r){if(r?.showLargeMessageDialog)return!0;const c=r?.item?.file,s=String(r?.filename??c?.name??""),o=String(r?.mimeType??c?.type??"");return s!=="message.txt"?!1:!o||o==="text/plain"}function F(r,c){const s=[];return v.storage.splitOnWords||s.push(r.split(`
`).reduce(function(o,a){return o.length+a.length+2>c?(s.push(o),a+`
`):o?o+a+`
`:a+`
`},"")),s.length&&!s.some(function(o){return o.length>c})?s.map(function(o){return o.trim()}):(s.length=0,s.push(r.split(" ").reduce(function(o,a){return o.length+a.length+2>c?(s.push(o),a+" "):o?o+a+" ":a+" "},"")),s.some(function(o){return o.length>c})?!1:s.map(function(o){return o.trim()}))}var at={onLoad(){const r=l.findByStoreName("ChannelStore"),c=l.findByStoreName("SelectedChannelStore"),s=l.findByStoreName("UserStore"),o=l.findByProps("sendMessage","editMessage"),a=l.findByProps("getDraft"),d=l.findByProps("clearDraft","saveDraft"),g=l.findByProps("clearAll"),z=l.findByProps("getUploads"),E=l.findByProps("promptToUpload"),G=l.findByProps("show","openLazy"),W=l.findByProps("openModal","openModalLazy"),ut=o.sendMessage.bind(o),q=async function(n,t,e){const i={invalidEmojis:t.invalidEmojis,validNonShortcutEmojis:t.validNonShortcutEmojis,tts:!1,content:e};if(typeof o._sendMessage=="function"){await o._sendMessage(n,i,{});return}await ut(n,i)},y=function(){return s.getCurrentUser()?.premiumType===2?4e3:2e3},J=async function(n,t){for(const e of t)await q(n,{},e)},lt=function(n){if(!z?.getUploads)return[];try{const t=z.getUploads(n,0);if(Array.isArray(t))return t}catch{}try{const t=z.getUploads(n);if(Array.isArray(t))return t}catch{}return[]},dt=function(n){try{d?.clearDraft?.(n,0)}catch{}try{d?.clearDraft?.(n)}catch{}try{g?.clearAll?.(n,0)}catch{}try{g?.clearAll?.(n)}catch{}},gt=function(n,t){if(!d?.saveDraft)return!1;const e=A(n,a),i=[function(){return d.saveDraft(n,0,t)},function(){return d.saveDraft(n,t,0)},function(){return d.saveDraft(n,t)}];for(const f of i)try{f();const u=A(n,a);if(u===t||u.length>e.length)return!0}catch{}return!1},K=function(n){if(I.has(n))return;const t=lt(n);if(!t.length||!t.every(ft))return;const e=t[0]?.item?.file;e?.text&&(I.add(n),e.text().then(function(i){if(!(!i||i.length<=y())){if(A(n,a)===i){try{g?.clearAll?.(n,0)}catch{}try{g?.clearAll?.(n)}catch{}return}if(gt(n,i)){try{g?.clearAll?.(n,0)}catch{}try{g?.clearAll?.(n)}catch{}}}}).catch(function(){}).finally(function(){I.delete(n)}))},Q=function(){const n=c?.getChannelId?.();n&&K(n)},Z=function(n,t){const e=(typeof t=="string"?t:"")||A(n,a);if(!e||e.length<=y())return!1;const i=F(e,y());if(!i?.length)return!1;const f=i.filter(function(u){return u.length>0});return f.length?(J(n,f),dt(n),!0):!1},w=function(n,t){return!!(Z(n,t)||(K(n),Z(n)))},pt=function(n,t){return!t?.text||!Y(t)?!1:(t.text().then(function(e){!e||e.length<=y()||w(n,e)}).catch(function(){}),!0)},ht=function(n,t){const e=n?.channel?.id??n?.channelId??c?.getChannelId?.();if(!e)return t(n);const i=B(n)||A(e,a);return w(e,i)?{shouldClear:!1,shouldRefocus:!0}:t(n)},yt=function(n,t){const e=R(n).join(" ").replace(/\s+/g," ").toLowerCase(),i=String(k.i18n?.Messages?.YOUR_MESSAGE_IS_TOO_LONG??"").toLowerCase();if(!(e.includes("your message is too long")||e.includes("up to 4000 characters")||e.includes("2000 character count limit")||e.includes("your_message_is_too_long")||e.includes("showlargemessagedialog")||i&&e.includes(i)))return t(...n);const f=c?.getChannelId?.();if(!f)return t(...n);if(!w(f))return t(...n)},$=function(){const n=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.openWarningPopout=="function"});for(const t of n)if(!T.has(t)){T.add(t);try{S.push(m.instead("openWarningPopout",t,function([e],i){return ht(e,i)}))}catch{}}},tt=function(){const n=[];G&&typeof G=="object"&&n.push(G),W&&typeof W=="object"&&n.push(W),n.push(...l.findAll(function(t){return t&&typeof t=="object"&&(typeof t.show=="function"||typeof t.openLazy=="function"||typeof t.openModal=="function"||typeof t.openModalLazy=="function")}));for(const t of n)if(!N.has(t)){N.add(t);for(const e of["show","openLazy","openModal","openModalLazy"])try{if(typeof t[e]!="function")continue;S.push(m.instead(e,t,function(i,f){return yt(i,f)}))}catch{}}},nt=function(){const n=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.promptToUpload=="function"});E&&typeof E=="object"&&typeof E.promptToUpload=="function"&&n.push(E);for(const t of n)if(!P.has(t)){P.add(t);try{S.push(m.instead("promptToUpload",t,function([e,i,f],u){const p=e?.[0],h=i?.id??c?.getChannelId?.(),V=Y(p),mt=f===0||f==null;if(!h||!V||!mt||!pt(h,p)&&!w(h))return u(e,i,f)}))}catch{}}},et=function(){const n=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.handleSendMessage=="function"});for(const t of n)if(!U.has(t)){U.add(t);try{S.push(m.instead("handleSendMessage",t,function(e,i){const[f]=e,u=f?.channel?.id??f?.channelId??f?.id??c?.getChannelId?.();if(!u)return i(...e);const p=B(f);if(!w(u,p))return i(...e)}))}catch{}}},ot=function(){const n=["showLargeMessageDialog","showMessageTooLongDialog","openLargeMessageDialog"],t=l.findAll(function(e){return e&&typeof e=="object"&&n.some(function(i){return typeof e[i]=="function"})});for(const e of t)if(!x.has(e)){x.add(e);for(const i of n)try{if(typeof e[i]!="function")continue;S.push(m.instead(i,e,function(f,u){const[p]=f,h=p?.channel?.id??p?.channelId??p?.id??c?.getChannelId?.();if(!h)return u(...f);const V=B(p);if(!w(h,V))return u(...f)}))}catch{}}};X(),$(),tt(),nt(),et(),ot(),Q(),_=setInterval(Q,250),L=setInterval(function(){X(),$(),tt(),nt(),et(),ot()},3e3),j?.(),D?.(),j=m.before("sendMessage",o,function(n){const[t,e]=n,i=e?.content;if(!i||i.length<=y())return;const f=F(i,y());if(!f){e.content="",b.showToast("Failed to split message",M.getAssetIDByName("Small"));return}const u=f.filter(function(h){return h.length>0});if(!u.length){e.content="",b.showToast("Failed to split message",M.getAssetIDByName("Small"));return}e.content=u.shift()??"";const p=r.getChannel(t);(async function(){for(const h of u)await ct(Math.max((p?.rateLimitPerUser??0)*1e3,1e3)),await q(t,e,h)})()}),typeof o._sendMessage=="function"&&(D=m.before("_sendMessage",o,function(n){const[t,e]=n,i=e?.content;if(!i||i.length<=y())return;const f=F(i,y());if(!f){e.content="",b.showToast("Failed to split message",M.getAssetIDByName("Small"));return}const u=f.filter(function(p){return p.length>0});if(!u.length){e.content="",b.showToast("Failed to split message",M.getAssetIDByName("Small"));return}e.content=u.shift()??"",J(t,u)}))},onUnload:function(){for(j?.(),j=void 0,D?.(),D=void 0,L&&(clearInterval(L),L=void 0),_&&(clearInterval(_),_=void 0);S.length;)try{S.pop()?.()}catch{}T.clear(),N.clear(),P.clear(),U.clear(),x.clear(),I.clear(),it()},settings:st};return O.default=at,Object.defineProperty(O,"__esModule",{value:!0}),O})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta.storage);
