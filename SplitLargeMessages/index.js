(function(j,u,P,p,g,_,I,N,H){"use strict";function V(){return H.useProxy(g.storage),React.createElement(N.ErrorBoundary,null,React.createElement(P.ReactNative.ScrollView,null,React.createElement(N.Forms.FormSwitchRow,{label:"Split messages on words instead of newlines",subLabel:"Results in the lowest amount of messages",onValueChange:function(c){return g.storage.splitOnWords=c},value:g.storage.splitOnWords})))}let m;const S=new Map,d=[],A=new Set,E=new Set,C=new Set,O=new Set;let w;g.storage.splitOnWords??=!1;function X(){S.clear();const c=u.findAll(function(e){return e&&typeof e=="object"&&Object.keys(e).some(function(s){return s.includes("MAX_MESSAGE_LENGTH")})});for(const e of c){const s={};let o=!1;for(const a of Object.keys(e))a.includes("MAX_MESSAGE_LENGTH")&&typeof e[a]=="number"&&(s[a]=e[a],e[a]=2**30,o=!0);o&&S.set(e,s)}}function Y(){for(const[c,e]of S)for(const[s,o]of Object.entries(e))c[s]=o;S.clear()}function q(c){return new Promise(function(e){return setTimeout(e,c)})}function B(c,e=[],s=0){if(c==null||s>6)return e;if(typeof c=="string")return e.push(c),e;if(Array.isArray(c)){for(const o of c)B(o,e,s+1);return e}if(typeof c=="object")for(const[o,a]of Object.entries(c))o==="onConfirm"||o==="onCancel"||o==="render"||o==="children"||B(a,e,s+1);return e}function T(c,e){if(!e?.getDraft)return"";try{const s=e.getDraft(c,0);if(typeof s=="string")return s}catch{}try{const s=e.getDraft(c);if(typeof s=="string")return s}catch{}return""}function Q(c){if(!c)return!1;const e=String(c.name??""),s=String(c.type??"");return e!=="message.txt"?!1:!s||s==="text/plain"}function D(c,e){const s=[];return g.storage.splitOnWords||s.push(c.split(`
`).reduce(function(o,a){return o.length+a.length+2>e?(s.push(o),a+`
`):o?o+a+`
`:a+`
`},"")),s.length&&!s.some(function(o){return o.length>e})?s.map(function(o){return o.trim()}):(s.length=0,s.push(c.split(" ").reduce(function(o,a){return o.length+a.length+2>e?(s.push(o),a+" "):o?o+a+" ":a+" "},"")),s.some(function(o){return o.length>e})?!1:s.map(function(o){return o.trim()}))}var Z={onLoad(){const c=u.findByStoreName("ChannelStore"),e=u.findByStoreName("SelectedChannelStore"),s=u.findByStoreName("UserStore"),o=u.findByProps("sendMessage","editMessage"),a=u.findByProps("getDraft"),R=u.findByProps("clearDraft","saveDraft"),U=u.findByProps("clearAll"),v=u.findByProps("promptToUpload"),L=u.findByProps("show","openLazy"),$=o.sendMessage.bind(o),x=async function(n,t,r){const i={invalidEmojis:t.invalidEmojis,validNonShortcutEmojis:t.validNonShortcutEmojis,tts:!1,content:r};if(typeof o._sendMessage=="function"){await o._sendMessage(n,i,{});return}await $(n,i)},b=function(){return s.getCurrentUser()?.premiumType===2?4e3:2e3},J=async function(n,t){for(const r of t)await x(n,{},r)},K=function(n){try{R?.clearDraft?.(n,0)}catch{}try{R?.clearDraft?.(n)}catch{}try{U?.clearAll?.(n,0)}catch{}try{U?.clearAll?.(n)}catch{}},M=function(n,t){const r=(typeof t=="string"?t:"")||T(n,a);if(!r||r.length<=b())return!1;const i=D(r,b());if(!i?.length)return!1;const f=i.filter(function(l){return l.length>0});return f.length?(J(n,f),K(n),!0):!1},tt=function(n,t){const r=n?.channel?.id??n?.channelId??e?.getChannelId?.();if(!r)return t(n);const i=(typeof n?.content=="string"?n.content:"")||(typeof n?.text=="string"?n.text:"")||T(r,a);return M(r,i)?{shouldClear:!1,shouldRefocus:!0}:t(n)},G=function(n,t){const r=B(n).join(" ").replace(/\s+/g," ").toLowerCase(),i=String(P.i18n?.Messages?.YOUR_MESSAGE_IS_TOO_LONG??"").toLowerCase();if(!(r.includes("your message is too long")||r.includes("up to 4000 characters")||r.includes("2000 character count limit")||i&&r.includes(i)))return t(...n);const f=e?.getChannelId?.();if(!f)return t(...n);if(!M(f))return t(...n)},W=function(){const n=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.openWarningPopout=="function"});for(const t of n)if(!A.has(t)){A.add(t);try{d.push(p.instead("openWarningPopout",t,function([r],i){return tt(r,i)}))}catch{}}},z=function(){const n=[];L&&typeof L=="object"&&n.push(L),n.push(...u.findAll(function(t){return t&&typeof t=="object"&&(typeof t.show=="function"||typeof t.openLazy=="function")}));for(const t of n)if(!E.has(t)){E.add(t);try{typeof t.show=="function"&&d.push(p.instead("show",t,function(r,i){return G(r,i)}))}catch{}try{typeof t.openLazy=="function"&&d.push(p.instead("openLazy",t,function(r,i){return G(r,i)}))}catch{}}},F=function(){const n=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.promptToUpload=="function"});v&&typeof v=="object"&&typeof v.promptToUpload=="function"&&n.push(v);for(const t of n)if(!C.has(t)){C.add(t);try{d.push(p.instead("promptToUpload",t,function([r,i,f],l){const y=r?.[0],h=i?.id??e?.getChannelId?.(),nt=Q(y),et=f===0||f==null;if(!h||!nt||!et||!M(h))return l(r,i,f)}))}catch{}}},k=function(){const n=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.handleSendMessage=="function"&&(typeof t.onResize=="function"||typeof t.getSendMessageOptions=="function")});for(const t of n)if(!O.has(t)){O.add(t);try{d.push(p.instead("handleSendMessage",t,function(r,i){const[f]=r,l=f?.channel?.id??f?.channelId??f?.id??e?.getChannelId?.();if(!l)return i(...r);const y=(typeof f?.content=="string"?f.content:"")||(typeof f?.text=="string"?f.text:"")||(typeof f?.message?.content=="string"?f.message.content:"");if(!M(l,y))return i(...r)}))}catch{}}};X(),W(),z(),F(),k(),w=setInterval(function(){W(),z(),F(),k()},3e3),m?.(),m=p.before("sendMessage",o,function(n){const[t,r]=n,i=r?.content;if(!i||i.length<=b())return;const f=D(i,b());if(!f){r.content="",I.showToast("Failed to split message",_.getAssetIDByName("Small"));return}const l=f.filter(function(h){return h.length>0});if(!l.length){r.content="",I.showToast("Failed to split message",_.getAssetIDByName("Small"));return}r.content=l.shift()??"";const y=c.getChannel(t);(async function(){for(const h of l)await q(Math.max((y?.rateLimitPerUser??0)*1e3,1e3)),await x(t,r,h)})()})},onUnload:function(){for(m?.(),m=void 0,w&&(clearInterval(w),w=void 0);d.length;)try{d.pop()?.()}catch{}A.clear(),E.clear(),C.clear(),O.clear(),Y()},settings:V};return j.default=Z,Object.defineProperty(j,"__esModule",{value:!0}),j})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta.storage);
