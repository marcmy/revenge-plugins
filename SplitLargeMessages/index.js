(function(P,l,k,y,w,A,b,H,ot){"use strict";function rt(){return ot.useProxy(w.storage),React.createElement(H.ErrorBoundary,null,React.createElement(k.ReactNative.ScrollView,null,React.createElement(H.Forms.FormSwitchRow,{label:"Split messages on words instead of newlines",subLabel:"Results in the lowest amount of messages",onValueChange:function(r){return w.storage.splitOnWords=r},value:w.storage.splitOnWords})))}let j,D;const C=new Map,m=[],O=new Set,T=new Set,N=new Set,U=new Set,x=new Set,I=new Set;let L,_;w.storage.splitOnWords??=!1;function X(){const r=function(s){if(!s||typeof s!="object")return;const o=s,f=C.get(o)??{};let d=!1;for(const p of Object.keys(o))p.includes("MAX_MESSAGE_LENGTH")&&typeof o[p]=="number"&&(p in f||(f[p]=o[p]),o[p]=1073741824,d=!0);d&&C.set(o,f)},c=l.findAll(function(s){return s&&typeof s=="object"&&Object.keys(s).some(function(o){return o.includes("MAX_MESSAGE_LENGTH")})});for(const s of c){r(s);for(const o of Object.values(s))!o||typeof o!="object"||r(o)}}function st(){for(const[r,c]of C)for(const[s,o]of Object.entries(c))r[s]=o;C.clear()}function it(r){return new Promise(function(c){return setTimeout(c,r)})}function R(r,c=[],s=0){if(r==null||s>6)return c;if(typeof r=="string")return c.push(r),c;if(typeof r=="function"){try{c.push(Function.prototype.toString.call(r))}catch{}return c}if(Array.isArray(r)){for(const o of r)R(o,c,s+1);return c}if(typeof r=="object")for(const[o,f]of Object.entries(r))o==="onConfirm"||o==="onCancel"||o==="render"||o==="children"||R(f,c,s+1);return c}function B(r,c=0){if(c>4||r==null)return"";if(typeof r=="string")return r;if(typeof r!="object")return"";const s=["content","text","value","rawContent","messageContent","pendingContent"];for(const f of s){const d=r[f];if(typeof d=="string"&&d.length>0)return d}const o=["message","draft","state","editor","input","composerState","formState","richValue"];for(const f of o){const d=B(r[f],c+1);if(d)return d}return""}function v(r,c){if(!c?.getDraft)return"";try{const s=c.getDraft(r,0);if(typeof s=="string")return s}catch{}try{const s=c.getDraft(r);if(typeof s=="string")return s}catch{}return""}function ct(r){if(!r)return!1;const c=String(r.name??""),s=String(r.type??"");return c!=="message.txt"?!1:!s||s==="text/plain"}function at(r){if(r?.showLargeMessageDialog)return!0;const c=r?.item?.file,s=String(r?.filename??c?.name??""),o=String(r?.mimeType??c?.type??"");return s!=="message.txt"?!1:!o||o==="text/plain"}function z(r,c){const s=[];return w.storage.splitOnWords||s.push(r.split(`
`).reduce(function(o,f){return o.length+f.length+2>c?(s.push(o),f+`
`):o?o+f+`
`:f+`
`},"")),s.length&&!s.some(function(o){return o.length>c})?s.map(function(o){return o.trim()}):(s.length=0,s.push(r.split(" ").reduce(function(o,f){return o.length+f.length+2>c?(s.push(o),f+" "):o?o+f+" ":f+" "},"")),s.some(function(o){return o.length>c})?!1:s.map(function(o){return o.trim()}))}var ft={onLoad(){const r=l.findByStoreName("ChannelStore"),c=l.findByStoreName("SelectedChannelStore"),s=l.findByStoreName("UserStore"),o=l.findByProps("sendMessage","editMessage"),f=l.findByProps("getDraft"),d=l.findByProps("clearDraft","saveDraft"),p=l.findByProps("clearAll"),F=l.findByProps("getUploads"),E=l.findByProps("promptToUpload"),G=l.findByProps("show","openLazy"),W=l.findByProps("openModal","openModalLazy"),ut=o.sendMessage.bind(o),Y=async function(n,t,e){const i={invalidEmojis:t.invalidEmojis,validNonShortcutEmojis:t.validNonShortcutEmojis,tts:!1,content:e};if(typeof o._sendMessage=="function"){await o._sendMessage(n,i,{});return}await ut(n,i)},S=function(){return s.getCurrentUser()?.premiumType===2?4e3:2e3},q=async function(n,t){for(const e of t)await Y(n,{},e)},lt=function(n){if(!F?.getUploads)return[];try{const t=F.getUploads(n,0);if(Array.isArray(t))return t}catch{}try{const t=F.getUploads(n);if(Array.isArray(t))return t}catch{}return[]},dt=function(n){try{d?.clearDraft?.(n,0)}catch{}try{d?.clearDraft?.(n)}catch{}try{p?.clearAll?.(n,0)}catch{}try{p?.clearAll?.(n)}catch{}},pt=function(n,t){if(!d?.saveDraft)return!1;const e=v(n,f),i=[function(){return d.saveDraft(n,0,t)},function(){return d.saveDraft(n,t,0)},function(){return d.saveDraft(n,t)}];for(const a of i)try{a();const u=v(n,f);if(u===t||u.length>e.length)return!0}catch{}return!1},J=function(n){if(I.has(n))return;const t=lt(n);if(!t.length||!t.every(at))return;const e=t[0]?.item?.file;e?.text&&(I.add(n),e.text().then(function(i){if(!(!i||i.length<=S())){if(v(n,f)===i){try{p?.clearAll?.(n,0)}catch{}try{p?.clearAll?.(n)}catch{}return}if(pt(n,i)){try{p?.clearAll?.(n,0)}catch{}try{p?.clearAll?.(n)}catch{}}}}).catch(function(){}).finally(function(){I.delete(n)}))},K=function(){const n=c?.getChannelId?.();n&&J(n)},Q=function(n,t){const e=(typeof t=="string"?t:"")||v(n,f);if(!e||e.length<=S())return!1;const i=z(e,S());if(!i?.length)return!1;const a=i.filter(function(u){return u.length>0});return a.length?(q(n,a),dt(n),!0):!1},M=function(n,t){return!!(Q(n,t)||(J(n),Q(n)))},gt=function(n,t){const e=n?.channel?.id??n?.channelId??c?.getChannelId?.();if(!e)return t(n);const i=B(n)||v(e,f);return M(e,i)?{shouldClear:!1,shouldRefocus:!0}:t(n)},ht=function(n,t){const e=R(n).join(" ").replace(/\s+/g," ").toLowerCase(),i=String(k.i18n?.Messages?.YOUR_MESSAGE_IS_TOO_LONG??"").toLowerCase();if(!(e.includes("your message is too long")||e.includes("up to 4000 characters")||e.includes("2000 character count limit")||e.includes("your_message_is_too_long")||e.includes("showlargemessagedialog")||i&&e.includes(i)))return t(...n);const a=c?.getChannelId?.();if(!a)return t(...n);if(!M(a))return t(...n)},Z=function(){const n=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.openWarningPopout=="function"});for(const t of n)if(!O.has(t)){O.add(t);try{m.push(y.instead("openWarningPopout",t,function([e],i){return gt(e,i)}))}catch{}}},$=function(){const n=[];G&&typeof G=="object"&&n.push(G),W&&typeof W=="object"&&n.push(W),n.push(...l.findAll(function(t){return t&&typeof t=="object"&&(typeof t.show=="function"||typeof t.openLazy=="function"||typeof t.openModal=="function"||typeof t.openModalLazy=="function")}));for(const t of n)if(!T.has(t)){T.add(t);for(const e of["show","openLazy","openModal","openModalLazy"])try{if(typeof t[e]!="function")continue;m.push(y.instead(e,t,function(i,a){return ht(i,a)}))}catch{}}},tt=function(){const n=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.promptToUpload=="function"});E&&typeof E=="object"&&typeof E.promptToUpload=="function"&&n.push(E);for(const t of n)if(!N.has(t)){N.add(t);try{m.push(y.instead("promptToUpload",t,function([e,i,a],u){const g=e?.[0],h=i?.id??c?.getChannelId?.(),V=ct(g),yt=a===0||a==null;if(!h||!V||!yt||!M(h))return u(e,i,a)}))}catch{}}},nt=function(){const n=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.handleSendMessage=="function"});for(const t of n)if(!U.has(t)){U.add(t);try{m.push(y.instead("handleSendMessage",t,function(e,i){const[a]=e,u=a?.channel?.id??a?.channelId??a?.id??c?.getChannelId?.();if(!u)return i(...e);const g=B(a);if(!M(u,g))return i(...e)}))}catch{}}},et=function(){const n=["showLargeMessageDialog","showMessageTooLongDialog","openLargeMessageDialog"],t=l.findAll(function(e){return e&&typeof e=="object"&&n.some(function(i){return typeof e[i]=="function"})});for(const e of t)if(!x.has(e)){x.add(e);for(const i of n)try{if(typeof e[i]!="function")continue;m.push(y.instead(i,e,function(a,u){const[g]=a,h=g?.channel?.id??g?.channelId??g?.id??c?.getChannelId?.();if(!h)return u(...a);const V=B(g);if(!M(h,V))return u(...a)}))}catch{}}};X(),Z(),$(),tt(),nt(),et(),K(),_=setInterval(K,250),L=setInterval(function(){X(),Z(),$(),tt(),nt(),et()},3e3),j?.(),D?.(),j=y.before("sendMessage",o,function(n){const[t,e]=n,i=e?.content;if(!i||i.length<=S())return;const a=z(i,S());if(!a){e.content="",b.showToast("Failed to split message",A.getAssetIDByName("Small"));return}const u=a.filter(function(h){return h.length>0});if(!u.length){e.content="",b.showToast("Failed to split message",A.getAssetIDByName("Small"));return}e.content=u.shift()??"";const g=r.getChannel(t);(async function(){for(const h of u)await it(Math.max((g?.rateLimitPerUser??0)*1e3,1e3)),await Y(t,e,h)})()}),typeof o._sendMessage=="function"&&(D=y.before("_sendMessage",o,function(n){const[t,e]=n,i=e?.content;if(!i||i.length<=S())return;const a=z(i,S());if(!a){e.content="",b.showToast("Failed to split message",A.getAssetIDByName("Small"));return}const u=a.filter(function(g){return g.length>0});if(!u.length){e.content="",b.showToast("Failed to split message",A.getAssetIDByName("Small"));return}e.content=u.shift()??"",q(t,u)}))},onUnload:function(){for(j?.(),j=void 0,D?.(),D=void 0,L&&(clearInterval(L),L=void 0),_&&(clearInterval(_),_=void 0);m.length;)try{m.pop()?.()}catch{}O.clear(),T.clear(),N.clear(),U.clear(),x.clear(),I.clear(),st()},settings:rt};return P.default=ft,Object.defineProperty(P,"__esModule",{value:!0}),P})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta.storage);
