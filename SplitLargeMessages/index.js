(function(D,u,P,S,w,_,N,T,H){"use strict";function X(){return H.useProxy(w.storage),React.createElement(T.ErrorBoundary,null,React.createElement(P.ReactNative.ScrollView,null,React.createElement(T.Forms.FormSwitchRow,{label:"Split messages on words instead of newlines",subLabel:"Results in the lowest amount of messages",onValueChange:function(s){return w.storage.splitOnWords=s},value:w.storage.splitOnWords})))}let v;const A=new Map,p=[],I=new WeakSet,U=new WeakSet,W=new WeakSet;let b;w.storage.splitOnWords??=!1;function V(){A.clear();const s=u.findAll(function(n){return n&&typeof n=="object"&&Object.keys(n).some(function(o){return o.includes("MAX_MESSAGE_LENGTH")})});for(const n of s){const o={};let e=!1;for(const a of Object.keys(n))a.includes("MAX_MESSAGE_LENGTH")&&typeof n[a]=="number"&&(o[a]=n[a],n[a]=2**30,e=!0);e&&A.set(n,o)}}function q(){for(const[s,n]of A)for(const[o,e]of Object.entries(n))s[o]=e;A.clear()}function K(s){return new Promise(function(n){return setTimeout(n,s)})}function M(s,n=[],o=0){if(s==null||o>6)return n;if(typeof s=="string")return n.push(s),n;if(Array.isArray(s)){for(const e of s)M(e,n,o+1);return n}if(typeof s=="object")for(const[e,a]of Object.entries(s))e==="onConfirm"||e==="onCancel"||e==="render"||e==="children"||M(a,n,o+1);return n}function C(s,n){if(!n?.getDraft)return"";try{const o=n.getDraft(s,0);if(typeof o=="string")return o}catch{}try{const o=n.getDraft(s);if(typeof o=="string")return o}catch{}return""}function Q(s){if(!s)return!1;const n=String(s.name??""),o=String(s.type??"");return n!=="message.txt"?!1:!o||o==="text/plain"}function j(s,n){const o=[];return w.storage.splitOnWords||o.push(s.split(`
`).reduce(function(e,a){return e.length+a.length+2>n?(o.push(e),a+`
`):e?e+a+`
`:a+`
`},"")),o.length&&!o.some(function(e){return e.length>n})?o.map(function(e){return e.trim()}):(o.length=0,o.push(s.split(" ").reduce(function(e,a){return e.length+a.length+2>n?(o.push(e),a+" "):e?e+a+" ":a+" "},"")),o.some(function(e){return e.length>n})?!1:o.map(function(e){return e.trim()}))}var Y={onLoad(){const s=u.findByStoreName("ChannelStore"),n=u.findByStoreName("SelectedChannelStore"),o=u.findByStoreName("UserStore"),e=u.findByProps("sendMessage","editMessage"),a=u.findByProps("getDraft"),y=u.findByProps("clearDraft","saveDraft"),g=u.findByProps("clearAll"),E=u.findByProps("promptToUpload"),O=u.findByProps("show","openLazy"),Z=e.sendMessage.bind(e),R=async function(c,t,r){const i={invalidEmojis:t.invalidEmojis,validNonShortcutEmojis:t.validNonShortcutEmojis,tts:!1,content:r};if(typeof e._sendMessage=="function"){await e._sendMessage(c,i,{});return}await Z(c,i)},h=function(){return o.getCurrentUser()?.premiumType===2?4e3:2e3},B=async function(c,t){for(const r of t)await R(c,{},r)},$=function(c,t){const r=c?.channel?.id??c?.channelId??n?.getChannelId?.();if(!r)return t(c);const i=(typeof c?.content=="string"?c.content:"")||(typeof c?.text=="string"?c.text:"")||C(r,a);if(!i||i.length<=h())return t(c);const f=j(i,h());if(!f?.length)return t(c);B(r,f.filter(function(l){return l.length>0}));try{y?.clearDraft?.(r,0)}catch{}try{y?.clearDraft?.(r)}catch{}try{g?.clearAll?.(r,0)}catch{}try{g?.clearAll?.(r)}catch{}return{shouldClear:!1,shouldRefocus:!0}},k=function(c,t){const r=M(c).join(" ").replace(/\s+/g," ").toLowerCase(),i=String(P.i18n?.Messages?.YOUR_MESSAGE_IS_TOO_LONG??"").toLowerCase();if(!(r.includes("your message is too long")||r.includes("up to 4000 characters")||r.includes("2000 character count limit")||i&&r.includes(i)))return t(...c);const f=n?.getChannelId?.();if(!f)return t(...c);const l=C(f,a);if(!l||l.length<=h())return t(...c);const m=j(l,h());if(!m?.length)return t(...c);B(f,m.filter(function(d){return d.length>0}));try{y?.clearDraft?.(f,0)}catch{}try{y?.clearDraft?.(f)}catch{}try{g?.clearAll?.(f,0)}catch{}try{g?.clearAll?.(f)}catch{}},x=function(){const c=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.openWarningPopout=="function"});for(const t of c)if(!I.has(t)){I.add(t);try{p.push(S.instead("openWarningPopout",t,function([r],i){return $(r,i)}))}catch{}}},G=function(){const c=[];O&&typeof O=="object"&&c.push(O),c.push(...u.findAll(function(t){return t&&typeof t=="object"&&(typeof t.show=="function"||typeof t.openLazy=="function")}));for(const t of c)if(!U.has(t)){U.add(t);try{typeof t.show=="function"&&p.push(S.instead("show",t,function(r,i){return k(r,i)}))}catch{}try{typeof t.openLazy=="function"&&p.push(S.instead("openLazy",t,function(r,i){return k(r,i)}))}catch{}}},F=function(){const c=u.findAll(function(t){return t&&typeof t=="object"&&typeof t.promptToUpload=="function"});E&&typeof E=="object"&&typeof E.promptToUpload=="function"&&c.push(E);for(const t of c)if(!W.has(t)){W.add(t);try{p.push(S.instead("promptToUpload",t,function([r,i,f],l){const m=r?.[0],d=i?.id??n?.getChannelId?.(),J=Q(m),tt=f===0||f==null;if(!d||!J||!tt)return l(r,i,f);const L=C(d,a);if(!L||L.length<=h())return l(r,i,f);const z=j(L,h());if(!z?.length)return l(r,i,f);B(d,z.filter(function(nt){return nt.length>0}));try{y?.clearDraft?.(d,0)}catch{}try{y?.clearDraft?.(d)}catch{}try{g?.clearAll?.(d,0)}catch{}try{g?.clearAll?.(d)}catch{}}))}catch{}}};V(),x(),G(),F(),b=setInterval(function(){x(),G(),F()},3e3),v?.(),v=S.before("sendMessage",e,function(c){const[t,r]=c,i=r?.content;if(!i||i.length<=h())return;const f=j(i,h());if(!f){r.content="",N.showToast("Failed to split message",_.getAssetIDByName("Small"));return}const l=f.filter(function(d){return d.length>0});if(!l.length){r.content="",N.showToast("Failed to split message",_.getAssetIDByName("Small"));return}r.content=l.shift()??"";const m=s.getChannel(t);(async function(){for(const d of l)await K(Math.max((m?.rateLimitPerUser??0)*1e3,1e3)),await R(t,r,d)})()})},onUnload:function(){for(v?.(),v=void 0,b&&(clearInterval(b),b=void 0);p.length;)try{p.pop()?.()}catch{}q()},settings:X};return D.default=Y,Object.defineProperty(D,"__esModule",{value:!0}),D})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta.storage);
