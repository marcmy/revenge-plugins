(function(E,l,k,h,w,A,b,H,nt){"use strict";function ot(){return nt.useProxy(w.storage),React.createElement(H.ErrorBoundary,null,React.createElement(k.ReactNative.ScrollView,null,React.createElement(H.Forms.FormSwitchRow,{label:"Split messages on words instead of newlines",subLabel:"Results in the lowest amount of messages",onValueChange:function(i){return w.storage.splitOnWords=i},value:w.storage.splitOnWords})))}let j,D;const I=new Map,m=[],O=new Set,T=new Set,x=new Set,N=new Set,P=new Set,L=new Set;let _,B;w.storage.splitOnWords??=!1;function V(){const i=function(r){if(!r||typeof r!="object")return;const o=r,a=I.get(o)??{};let p=!1;for(const g of Object.keys(o))g.includes("MAX_MESSAGE_LENGTH")&&typeof o[g]=="number"&&(g in a||(a[g]=o[g]),o[g]=1073741824,p=!0);p&&I.set(o,a)},c=l.findAll(function(r){return r&&typeof r=="object"&&Object.keys(r).some(function(o){return o.includes("MAX_MESSAGE_LENGTH")})});for(const r of c){i(r);for(const o of Object.values(r))!o||typeof o!="object"||i(o)}}function rt(){for(const[i,c]of I)for(const[r,o]of Object.entries(c))i[r]=o;I.clear()}function st(i){return new Promise(function(c){return setTimeout(c,i)})}function U(i,c=[],r=0){if(i==null||r>6)return c;if(typeof i=="string")return c.push(i),c;if(typeof i=="function"){try{c.push(Function.prototype.toString.call(i))}catch{}return c}if(Array.isArray(i)){for(const o of i)U(o,c,r+1);return c}if(typeof i=="object")for(const[o,a]of Object.entries(i))o==="onConfirm"||o==="onCancel"||o==="render"||o==="children"||U(a,c,r+1);return c}function v(i,c){if(!c?.getDraft)return"";try{const r=c.getDraft(i,0);if(typeof r=="string")return r}catch{}try{const r=c.getDraft(i);if(typeof r=="string")return r}catch{}return""}function ct(i){if(!i)return!1;const c=String(i.name??""),r=String(i.type??"");return c!=="message.txt"?!1:!r||r==="text/plain"}function it(i){if(i?.showLargeMessageDialog)return!0;const c=i?.item?.file,r=String(i?.filename??c?.name??""),o=String(i?.mimeType??c?.type??"");return r!=="message.txt"?!1:!o||o==="text/plain"}function R(i,c){const r=[];return w.storage.splitOnWords||r.push(i.split(`
`).reduce(function(o,a){return o.length+a.length+2>c?(r.push(o),a+`
`):o?o+a+`
`:a+`
`},"")),r.length&&!r.some(function(o){return o.length>c})?r.map(function(o){return o.trim()}):(r.length=0,r.push(i.split(" ").reduce(function(o,a){return o.length+a.length+2>c?(r.push(o),a+" "):o?o+a+" ":a+" "},"")),r.some(function(o){return o.length>c})?!1:r.map(function(o){return o.trim()}))}var ft={onLoad(){const i=l.findByStoreName("ChannelStore"),c=l.findByStoreName("SelectedChannelStore"),r=l.findByStoreName("UserStore"),o=l.findByProps("sendMessage","editMessage"),a=l.findByProps("getDraft"),p=l.findByProps("clearDraft","saveDraft"),g=l.findByProps("clearAll"),z=l.findByProps("getUploads"),C=l.findByProps("promptToUpload"),F=l.findByProps("show","openLazy"),G=l.findByProps("openModal","openModalLazy"),at=o.sendMessage.bind(o),X=async function(e,t,n){const s={invalidEmojis:t.invalidEmojis,validNonShortcutEmojis:t.validNonShortcutEmojis,tts:!1,content:n};if(typeof o._sendMessage=="function"){await o._sendMessage(e,s,{});return}await at(e,s)},S=function(){return r.getCurrentUser()?.premiumType===2?4e3:2e3},Y=async function(e,t){for(const n of t)await X(e,{},n)},ut=function(e){if(!z?.getUploads)return[];try{const t=z.getUploads(e,0);if(Array.isArray(t))return t}catch{}try{const t=z.getUploads(e);if(Array.isArray(t))return t}catch{}return[]},lt=function(e){try{p?.clearDraft?.(e,0)}catch{}try{p?.clearDraft?.(e)}catch{}try{g?.clearAll?.(e,0)}catch{}try{g?.clearAll?.(e)}catch{}},dt=function(e,t){if(!p?.saveDraft)return!1;const n=v(e,a),s=[function(){return p.saveDraft(e,0,t)},function(){return p.saveDraft(e,t,0)},function(){return p.saveDraft(e,t)}];for(const f of s)try{f();const u=v(e,a);if(u===t||u.length>n.length)return!0}catch{}return!1},q=function(e){if(L.has(e))return;const t=ut(e);if(!t.length||!t.every(it))return;const n=t[0]?.item?.file;n?.text&&(L.add(e),n.text().then(function(s){if(!(!s||s.length<=S())){if(v(e,a)===s){try{g?.clearAll?.(e,0)}catch{}try{g?.clearAll?.(e)}catch{}return}if(dt(e,s)){try{g?.clearAll?.(e,0)}catch{}try{g?.clearAll?.(e)}catch{}}}}).catch(function(){}).finally(function(){L.delete(e)}))},J=function(){const e=c?.getChannelId?.();e&&q(e)},K=function(e,t){const n=(typeof t=="string"?t:"")||v(e,a);if(!n||n.length<=S())return!1;const s=R(n,S());if(!s?.length)return!1;const f=s.filter(function(u){return u.length>0});return f.length?(Y(e,f),lt(e),!0):!1},M=function(e,t){return!!(K(e,t)||(q(e),K(e)))},gt=function(e,t){const n=e?.channel?.id??e?.channelId??c?.getChannelId?.();if(!n)return t(e);const s=(typeof e?.content=="string"?e.content:"")||(typeof e?.text=="string"?e.text:"")||v(n,a);return M(n,s)?{shouldClear:!1,shouldRefocus:!0}:t(e)},pt=function(e,t){const n=U(e).join(" ").replace(/\s+/g," ").toLowerCase(),s=String(k.i18n?.Messages?.YOUR_MESSAGE_IS_TOO_LONG??"").toLowerCase();if(!(n.includes("your message is too long")||n.includes("up to 4000 characters")||n.includes("2000 character count limit")||n.includes("your_message_is_too_long")||n.includes("showlargemessagedialog")||s&&n.includes(s)))return t(...e);const f=c?.getChannelId?.();if(!f)return t(...e);if(!M(f))return t(...e)},Q=function(){const e=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.openWarningPopout=="function"});for(const t of e)if(!O.has(t)){O.add(t);try{m.push(h.instead("openWarningPopout",t,function([n],s){return gt(n,s)}))}catch{}}},Z=function(){const e=[];F&&typeof F=="object"&&e.push(F),G&&typeof G=="object"&&e.push(G),e.push(...l.findAll(function(t){return t&&typeof t=="object"&&(typeof t.show=="function"||typeof t.openLazy=="function"||typeof t.openModal=="function"||typeof t.openModalLazy=="function")}));for(const t of e)if(!T.has(t)){T.add(t);for(const n of["show","openLazy","openModal","openModalLazy"])try{if(typeof t[n]!="function")continue;m.push(h.instead(n,t,function(s,f){return pt(s,f)}))}catch{}}},$=function(){const e=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.promptToUpload=="function"});C&&typeof C=="object"&&typeof C.promptToUpload=="function"&&e.push(C);for(const t of e)if(!x.has(t)){x.add(t);try{m.push(h.instead("promptToUpload",t,function([n,s,f],u){const d=n?.[0],y=s?.id??c?.getChannelId?.(),W=ct(d),yt=f===0||f==null;if(!y||!W||!yt||!M(y))return u(n,s,f)}))}catch{}}},tt=function(){const e=l.findAll(function(t){return t&&typeof t=="object"&&typeof t.handleSendMessage=="function"&&(typeof t.onResize=="function"||typeof t.getSendMessageOptions=="function")});for(const t of e)if(!N.has(t)){N.add(t);try{m.push(h.instead("handleSendMessage",t,function(n,s){const[f]=n,u=f?.channel?.id??f?.channelId??f?.id??c?.getChannelId?.();if(!u)return s(...n);const d=(typeof f?.content=="string"?f.content:"")||(typeof f?.text=="string"?f.text:"")||(typeof f?.message?.content=="string"?f.message.content:"");if(!M(u,d))return s(...n)}))}catch{}}},et=function(){const e=["showLargeMessageDialog","showMessageTooLongDialog","openLargeMessageDialog"],t=l.findAll(function(n){return n&&typeof n=="object"&&e.some(function(s){return typeof n[s]=="function"})});for(const n of t)if(!P.has(n)){P.add(n);for(const s of e)try{if(typeof n[s]!="function")continue;m.push(h.instead(s,n,function(f,u){const[d]=f,y=d?.channel?.id??d?.channelId??d?.id??c?.getChannelId?.();if(!y)return u(...f);const W=(typeof d?.content=="string"?d.content:"")||(typeof d?.text=="string"?d.text:"")||(typeof d?.message?.content=="string"?d.message.content:"");if(!M(y,W))return u(...f)}))}catch{}}};V(),Q(),Z(),$(),tt(),et(),J(),B=setInterval(J,250),_=setInterval(function(){V(),Q(),Z(),$(),tt(),et()},3e3),j?.(),D?.(),j=h.before("sendMessage",o,function(e){const[t,n]=e,s=n?.content;if(!s||s.length<=S())return;const f=R(s,S());if(!f){n.content="",b.showToast("Failed to split message",A.getAssetIDByName("Small"));return}const u=f.filter(function(y){return y.length>0});if(!u.length){n.content="",b.showToast("Failed to split message",A.getAssetIDByName("Small"));return}n.content=u.shift()??"";const d=i.getChannel(t);(async function(){for(const y of u)await st(Math.max((d?.rateLimitPerUser??0)*1e3,1e3)),await X(t,n,y)})()}),typeof o._sendMessage=="function"&&(D=h.before("_sendMessage",o,function(e){const[t,n]=e,s=n?.content;if(!s||s.length<=S())return;const f=R(s,S());if(!f){n.content="",b.showToast("Failed to split message",A.getAssetIDByName("Small"));return}const u=f.filter(function(d){return d.length>0});if(!u.length){n.content="",b.showToast("Failed to split message",A.getAssetIDByName("Small"));return}n.content=u.shift()??"",Y(t,u)}))},onUnload:function(){for(j?.(),j=void 0,D?.(),D=void 0,_&&(clearInterval(_),_=void 0),B&&(clearInterval(B),B=void 0);m.length;)try{m.pop()?.()}catch{}O.clear(),T.clear(),x.clear(),N.clear(),P.clear(),L.clear(),rt()},settings:ot};return E.default=ft,Object.defineProperty(E,"__esModule",{value:!0}),E})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta.storage);
